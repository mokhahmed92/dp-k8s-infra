# System Architecture - Spark on Kubernetes Data Platform

## High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                   External Access Layer                             │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌──────────────┐                                          ┌──────────────┐         │
│  │   kubectl    │                                          │     Helm     │         │
│  │   CLI        │                                          │   Package    │         │
│  └──────┬───────┘                                          └──────┬───────┘         │
│         │                                                         │                 │
│         └──────────────────────┬──────────────────────────────────┘                 │
│                                │                                                    │
├────────────────────────────────┼────────────────────────────────────────────────────┤
│                                │                                                    │
│                    K3D CLUSTER │ (data-platform-cluster)                            │
│                                ▼                                                    │
│  ┌──────────────────────────────────────────────────────────────────────────────┐   │
│  │                         Control Plane Node                                   │   │
│  │                    (k3d-data-platform-cluster-server-0)                      │   │
│  │  ┌─────────────┐  ┌──────────────┐  ┌─────────────┐  ┌──────────────┐     │  │   │  
│  │  │  API Server │  │   Scheduler  │  │ Controller  │  │     etcd     │     │  │   │
│  │  │             │  │   (default)  │  │   Manager   │  │              │     │  │   │
│  │  └─────────────┘  └──────────────┘  └─────────────┘  └──────────────┘     │  │   │
│  └──────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│         ┌─────────────────────────────┬─────────────────────────────┐               │
│         │                             │                             │               │
│         ▼                             ▼                             ▼               │
│  ┌──────────────┐             ┌──────────────┐             ┌──────────────┐         │
│  │  Worker Node │             │  Worker Node │             │ Network Layer│         │
│  │   (agent-0)  │             │   (agent-1)  │             │              │         │
│  │              │             │              │             │  - CoreDNS   │         │
│  │   kubelet    │             │   kubelet    │             │  - kube-proxy│         │
│  │   containerd │             │   containerd │             │  - CNI       │         │
│  └──────────────┘             └──────────────┘             └──────────────┘         │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## Platform Components Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              PLATFORM SERVICES LAYER                                │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌───────────────────────────────────────────────────────────────────────────────┐ │
│  │                           spark-operator namespace                            │ │
│  │  ┌──────────────────────────────────────────────────────────────────────┐   │ │
│  │  │                     Spark Operator v2.3.0                             │   │ │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐  │   │ │
│  │  │  │  Controller  │  │   Webhook    │  │      Configuration       │  │   │ │
│  │  │  │              │  │              │  │                          │  │   │ │
│  │  │  │  • Watches:  │  │  • Port:     │  │  • Batch Scheduler: On  │  │   │ │
│  │  │  │    - alpha   │  │    9443      │  │  • Metrics: 8080        │  │   │ │
│  │  │  │    - beta    │  │              │  │  • Workers: 10          │  │   │ │
│  │  │  │    - theta   │  │  • Validates │  │  • Leader Election: On  │  │   │ │
│  │  │  │    - delta   │  │    SparkApps │  │                          │  │   │ │
│  │  │  └──────────────┘  └──────────────┘  └──────────────────────────┘  │   │ │
│  │  └──────────────────────────────────────────────────────────────────────┘   │ │
│  └───────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                     │
│  ┌───────────────────────────────────────────────────────────────────────────────┐ │
│  │                          volcano-system namespace                             │ │
│  │  ┌──────────────────────────────────────────────────────────────────────┐   │ │
│  │  │                      Volcano v1.8.2                                   │   │ │
│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐  │   │ │
│  │  │  │  Scheduler   │  │  Controller  │  │      Admission          │  │   │ │
│  │  │  │              │  │              │  │                          │  │   │ │
│  │  │  │  • Queue     │  │  • Queue     │  │  • Webhook Validation   │  │   │ │
│  │  │  │    Mgmt      │  │    Lifecycle │  │  • Pod Mutation        │  │   │ │
│  │  │  │  • Gang      │  │  • PodGroup  │  │  • Queue Assignment    │  │   │ │
│  │  │  │    Schedule  │  │    Mgmt      │  │                          │  │   │ │
│  │  │  └──────────────┘  └──────────────┘  └──────────────────────────┘  │   │ │
│  │  └──────────────────────────────────────────────────────────────────────┘   │ │
│  └───────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## Multi-Tenant Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            MULTI-TENANT APPLICATION LAYER                           │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  Default Scheduler Teams                     Volcano Scheduler Teams               │
│  ┌─────────────────────────┐                ┌─────────────────────────┐           │
│  │      team-alpha         │                │      team-theta         │           │
│  │  ┌─────────────────┐   │                │  ┌─────────────────┐   │           │
│  │  │  Namespace      │   │                │  │  Namespace      │   │           │
│  │  │  • PySpark Jobs │   │                │  │  • Scala Jobs   │   │           │
│  │  │  • SA: alpha-sa │   │                │  │  • SA: theta-sa │   │           │
│  │  │  • Quota: 4-8CPU│   │                │  │  • Quota: 6-8CPU│   │           │
│  │  │  • Scheduler:   │   │                │  │  • Scheduler:   │   │           │
│  │  │    default      │   │                │  │    volcano      │   │           │
│  │  └─────────────────┘   │                │  │  • Queue: theta │   │           │
│  └─────────────────────────┘                │  └─────────────────┘   │           │
│                                              └─────────────────────────┘           │
│  ┌─────────────────────────┐                ┌─────────────────────────┐           │
│  │       team-beta         │                │      team-delta         │           │
│  │  ┌─────────────────┐   │                │  ┌─────────────────┐   │           │
│  │  │  Namespace      │   │                │  │  Namespace      │   │           │
│  │  │  • Scala Jobs   │   │                │  │  • PySpark Jobs │   │           │
│  │  │  • SA: beta-sa  │   │                │  │  • SA: delta-sa │   │           │
│  │  │  • Quota: 4-8CPU│   │                │  │  • Quota: 6-8CPU│   │           │
│  │  │  • Scheduler:   │   │                │  │  • Scheduler:   │   │           │
│  │  │    default      │   │                │  │    volcano      │   │           │
│  │  └─────────────────┘   │                │  │  • Queue: delta │   │           │
│  └─────────────────────────┘                │  └─────────────────┘   │           │
│                                              └─────────────────────────┘           │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## Spark Job Execution Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                            SPARK JOB EXECUTION WORKFLOW                             │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  1. Job Submission                                                                 │
│  ┌──────────┐      kubectl apply       ┌──────────────┐                          │
│  │   User   │ ─────────────────────────▶│SparkApplication│                        │
│  └──────────┘                           └──────┬───────┘                          │
│                                                 │                                  │
│  2. Operator Processing                         ▼                                  │
│                                    ┌──────────────────────┐                        │
│                                    │   Spark Operator     │                        │
│                                    │   • Validates spec   │                        │
│                                    │   • Creates driver   │                        │
│                                    └──────────┬───────────┘                        │
│                                                │                                   │
│  3. Scheduling Decision                        ▼                                   │
│         ┌───────────────────────────────────────────────────────┐                 │
│         │                  Scheduling Layer                      │                 │
│         │                                                        │                 │
│         │  ┌─────────────────┐      ┌─────────────────┐        │                 │
│         │  │ Default Scheduler│      │ Volcano Scheduler│        │                 │
│         │  │                 │      │                 │        │                 │
│         │  │ Teams:          │      │ Teams:          │        │                 │
│         │  │ • Alpha         │      │ • Theta         │        │                 │
│         │  │ • Beta          │      │ • Delta         │        │                 │
│         │  └─────────────────┘      └─────────────────┘        │                 │
│         └────────────────────────────┬──────────────────────────┘                 │
│                                      │                                            │
│  4. Pod Creation                     ▼                                            │
│                          ┌──────────────────────┐                                 │
│                          │    Driver Pod        │                                 │
│                          │  • Spark Context     │                                 │
│                          │  • Job Orchestration │                                 │
│                          └──────────┬───────────┘                                 │
│                                      │                                            │
│  5. Executor Management              ▼                                            │
│              ┌──────────────────────────────────────────┐                         │
│              │         Executor Pods                     │                         │
│              │  ┌──────────┐  ┌──────────┐  ┌────────┐ │                         │
│              │  │Executor 1│  │Executor 2│  │  ...   │ │                         │
│              │  └──────────┘  └──────────┘  └────────┘ │                         │
│              └──────────────────────────────────────────┘                         │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## Resource Management & Quotas

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          RESOURCE ALLOCATION ARCHITECTURE                           │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  Total Cluster Resources                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐      │
│  │  Control Plane: 2 CPU, 4Gi Memory                                       │      │
│  │  Worker Nodes:  4 CPU x 2 = 8 CPU, 8Gi x 2 = 16Gi Memory              │      │
│  │  Total Available: ~8 CPU, ~16Gi Memory (for workloads)                 │      │
│  └─────────────────────────────────────────────────────────────────────────┘      │
│                                                                                     │
│  Volcano Queue Distribution                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐      │
│  │                                                                          │      │
│  │   queue-theta (40%)          queue-delta (40%)         default (20%)   │      │
│  │   ┌──────────────┐          ┌──────────────┐         ┌──────────────┐ │      │
│  │   │              │          │              │         │              │ │      │
│  │   │  8 CPU       │          │  8 CPU       │         │  4 CPU       │ │      │
│  │   │  16Gi Memory │          │  16Gi Memory │         │  8Gi Memory  │ │      │
│  │   │              │          │              │         │              │ │      │
│  │   │  Guaranteed: │          │  Guaranteed: │         │  No Guarantee│ │      │
│  │   │  4CPU, 8Gi   │          │  4CPU, 8Gi   │         │              │ │      │
│  │   └──────────────┘          └──────────────┘         └──────────────┘ │      │
│  └─────────────────────────────────────────────────────────────────────────┘      │
│                                                                                     │
│  Namespace Resource Quotas                                                         │
│  ┌─────────────────────────────────────────────────────────────────────────┐      │
│  │                                                                          │      │
│  │   team-alpha         team-beta         team-theta        team-delta    │      │
│  │   ┌─────────┐       ┌─────────┐       ┌─────────┐      ┌─────────┐   │      │
│  │   │ Req: 4  │       │ Req: 4  │       │ Req: 6  │      │ Req: 6  │   │      │
│  │   │ Lim: 8  │       │ Lim: 8  │       │ Lim: 8  │      │ Lim: 8  │   │      │
│  │   │ CPU     │       │ CPU     │       │ CPU     │      │ CPU     │   │      │
│  │   │         │       │         │       │         │      │         │   │      │
│  │   │ Req: 8  │       │ Req: 8  │       │ Req: 12 │      │ Req: 12 │   │      │
│  │   │ Lim: 16 │       │ Lim: 16 │       │ Lim: 16 │      │ Lim: 16 │   │      │
│  │   │ Gi Mem  │       │ Gi Mem  │       │ Gi Mem  │      │ Gi Mem  │   │      │
│  │   │         │       │         │       │         │      │         │   │      │
│  │   │ Pods: 10│       │ Pods: 10│       │ Pods: 15│      │ Pods: 15│   │      │
│  │   └─────────┘       └─────────┘       └─────────┘      └─────────┘   │      │
│  └─────────────────────────────────────────────────────────────────────────┘      │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## Security & RBAC Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              SECURITY & RBAC LAYER                                  │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  Service Account Hierarchy                                                         │
│  ┌──────────────────────────────────────────────────────────────────┐             │
│  │                     Cluster-Level                                 │             │
│  │  ┌──────────────────────────────────────────────────────────┐   │             │
│  │  │  spark-operator SA (spark-operator namespace)            │   │             │
│  │  │  • ClusterRole: spark-operator-controller                │   │             │
│  │  │  • Permissions: Watch all team namespaces                │   │             │
│  │  └──────────────────────────────────────────────────────────┘   │             │
│  └──────────────────────────────────────────────────────────────────┘             │
│                                                                                     │
│  Team-Level Service Accounts                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐      │
│  │   ┌────────────────┐  ┌────────────────┐  ┌────────────────┐          │      │
│  │   │ team-alpha-sa  │  │ team-beta-sa   │  │ team-theta-sa  │          │      │
│  │   │                │  │                │  │                │          │      │
│  │   │ Permissions:   │  │ Permissions:   │  │ Permissions:   │          │      │
│  │   │ • Pods: CRUD   │  │ • Pods: CRUD   │  │ • Pods: CRUD   │          │      │
│  │   │ • Services     │  │ • Services     │  │ • Services     │          │      │
│  │   │ • ConfigMaps   │  │ • ConfigMaps   │  │ • ConfigMaps   │          │      │
│  │   │ • SparkApps    │  │ • SparkApps    │  │ • SparkApps    │          │      │
│  │   │                │  │                │  │ • PodGroups    │          │      │
│  │   │ Namespace:     │  │ Namespace:     │  │ • Queues (R)   │          │      │
│  │   │ team-alpha     │  │ team-beta      │  │                │          │      │
│  │   └────────────────┘  └────────────────┘  │ Namespace:     │          │      │
│  │                                            │ team-theta     │          │      │
│  │   ┌────────────────────────────────────┐  └────────────────┘          │      │
│  │   │        team-delta-sa               │                              │      │
│  │   │  Similar to team-theta-sa          │                              │      │
│  │   │  with Volcano permissions          │                              │      │
│  │   └────────────────────────────────────┘                              │      │
│  └─────────────────────────────────────────────────────────────────────────┘      │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## Network Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              NETWORK ARCHITECTURE                                   │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  External Access                                                                   │
│  ┌──────────────────────────────────────────────────────────────┐                │
│  │  Host Machine Ports                                           │                │
│  │  • 8080:80   - HTTP Traffic (future ingress)                │                │
│  │  • 8443:443  - HTTPS Traffic (future ingress)               │                │
│  │  • 6443      - Kubernetes API Server                        │                │
│  └────────────────────────┬──────────────────────────────────────┘                │
│                           │                                                        │
│  Cluster Networking       ▼                                                        │
│  ┌──────────────────────────────────────────────────────────────┐                │
│  │  Service Mesh                                                 │                │
│  │  ┌──────────────────────────────────────────────────────┐   │                │
│  │  │  ClusterIP Services                                   │   │                │
│  │  │  • spark-operator-webhook-svc (9443)                 │   │                │
│  │  │  • volcano-scheduler-service                          │   │                │
│  │  │  • volcano-admission-service                          │   │                │
│  │  └──────────────────────────────────────────────────────┘   │                │
│  │                                                               │                │
│  │  ┌──────────────────────────────────────────────────────┐   │                │
│  │  │  Pod-to-Pod Communication                             │   │                │
│  │  │  • Driver ←→ Executor communication                   │   │                │
│  │  │  • Spark shuffle service                              │   │                │
│  │  │  • Metrics collection                                 │   │                │
│  │  └──────────────────────────────────────────────────────┘   │                │
│  │                                                               │                │
│  │  ┌──────────────────────────────────────────────────────┐   │                │
│  │  │  Network Policies (Future)                            │   │                │
│  │  │  • Namespace isolation                                │   │                │
│  │  │  • Ingress/Egress rules per team                     │   │                │
│  │  │  • Service mesh integration                          │   │                │
│  │  └──────────────────────────────────────────────────────┘   │                │
│  └──────────────────────────────────────────────────────────────┘                │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## Data Flow Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                DATA FLOW PIPELINE                                   │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  Current State                                                                      │
│  ┌─────────────────────────────────────────────────────────────────┐              │
│  │  Local Examples                                                  │              │
│  │  • Pi Calculation (Math computations)                           │              │
│  │  • Local file system access                                     │              │
│  │  • In-memory processing                                         │              │
│  └─────────────────────────────────────────────────────────────────┘              │
│                                                                                     │
│  Future State (Planned)                                                            │
│  ┌─────────────────────────────────────────────────────────────────┐              │
│  │                                                                  │              │
│  │   Data Sources          Processing            Storage           │              │
│  │   ┌──────────┐         ┌──────────┐         ┌──────────┐     │              │
│  │   │  Kafka   │────────▶│  Spark   │────────▶│  MinIO   │     │              │
│  │   │  Streams │         │  Jobs    │         │  Buckets │     │              │
│  │   └──────────┘         └──────────┘         └──────────┘     │              │
│  │                              │                                  │              │
│  │   ┌──────────┐              │               ┌──────────┐     │              │
│  │   │  Files   │──────────────┘               │  HDFS    │     │              │
│  │   │  (S3/GCS)│                              │  (Future)│     │              │
│  │   └──────────┘                              └──────────┘     │              │
│  │                                                                  │              │
│  └─────────────────────────────────────────────────────────────────┘              │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```